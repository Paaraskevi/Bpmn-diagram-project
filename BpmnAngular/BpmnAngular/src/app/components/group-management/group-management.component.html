<!-- src/app/admin/group-management/group-management.component.html -->
<div class="group-management-container">
  <div class="header-section">
    <div class="page-header">
      <h1>
        <mat-icon>group</mat-icon>
        Group Management
      </h1>
      <p class="page-subtitle">
        Create and manage user groups for diagram assignment
      </p>
    </div>
  </div>

  <!-- Group Form Card -->
  <mat-card class="group-form-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>{{ editingGroup ? 'edit' : 'add_circle' }}</mat-icon>
        {{ editingGroup ? 'Edit' : 'Create' }} Group
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="groupForm" class="group-form">
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Group Name</mat-label>
            <input matInput formControlName="name"
              placeholder="Enter group name">
            <mat-error *ngIf="groupForm.get('name')?.hasError('required')">
              Group name is required
            </mat-error>
            <mat-error *ngIf="groupForm.get('name')?.hasError('minlength')">
              Group name must be at least 2 characters long
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Description</mat-label>
            <textarea matInput
              formControlName="description"
              rows="3"
              placeholder="Describe the purpose of this group"></textarea>
            <mat-error
              *ngIf="groupForm.get('description')?.hasError('maxlength')">
              Description cannot exceed 500 characters
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-actions">
          <button mat-raised-button
            color="primary"
            (click)="saveGroup()"
            [disabled]="!groupForm.valid || loading">
            <mat-icon>{{ editingGroup ? 'save' : 'add' }}</mat-icon>
            {{ editingGroup ? 'Update' : 'Create' }} Group
          </button>

          <button mat-button
            (click)="resetGroupForm()"
            *ngIf="editingGroup">
            <mat-icon>clear</mat-icon>
            Cancel
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Groups Table Card -->
  <mat-card class="groups-table-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>table_chart</mat-icon>
        Groups ({{ dataSource.filteredData?.length || 0 }})
      </mat-card-title>
      <div class="table-actions">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Search groups</mat-label>
          <input matInput (keyup)="applyFilter($event)"
            placeholder="Search by name or description">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
      </div>
    </mat-card-header>

    <mat-card-content>
      <div class="table-container">
        <table mat-table [dataSource]="dataSource" matSort class="groups-table">

          <!-- Name Column -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Group
              Name</th>
            <td mat-cell *matCellDef="let groupInfo">
              <div class="group-name">
                <mat-icon class="group-icon">group</mat-icon>
                <strong>{{ groupInfo.group.name }}</strong>
              </div>
            </td>
          </ng-container>

          <!-- Description Column -->
          <ng-container matColumnDef="description">
            <th mat-header-cell *matHeaderCellDef>Description</th>
            <td mat-cell *matCellDef="let groupInfo">
              <div class="group-description"
                [title]="groupInfo.group.description">
                {{ groupInfo.group.description || 'No description' }}
              </div>
            </td>
          </ng-container>

          <!-- User Count Column -->
          <ng-container matColumnDef="userCount">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Members</th>
            <td mat-cell *matCellDef="let groupInfo">
              <div class="user-count">
                <mat-chip color="primary" class="count-chip">
                  <mat-icon>people</mat-icon>
                  {{ groupInfo.userCount }}
                </mat-chip>
              </div>
            </td>
          </ng-container>

          <!-- Created By Column -->
          <ng-container matColumnDef="createdBy">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Created
              By</th>
            <td mat-cell *matCellDef="let groupInfo">
              <div class="creator-info">
                <mat-icon class="creator-icon">person</mat-icon>
                {{ groupInfo.group.createdBy }}
              </div>
            </td>
          </ng-container>

          <!-- Created Time Column -->
          <ng-container matColumnDef="createdTime">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Created</th>
            <td mat-cell *matCellDef="let groupInfo">
              <div class="date-info">
                {{ formatDate(groupInfo.group.uploadTime) }}
              </div>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let groupInfo">
              <div class="action-buttons">
                <button mat-icon-button
                  (click)="openUserManagement(groupInfo.group)"
                  matTooltip="Manage members"
                  color="primary">
                  <mat-icon>group_add</mat-icon>
                </button>

                <button mat-icon-button
                  (click)="editGroup(groupInfo.group)"
                  matTooltip="Edit group"
                  color="accent">
                  <mat-icon>edit</mat-icon>
                </button>

                <button mat-icon-button
                  (click)="deleteGroup(groupInfo.group)"
                  matTooltip="Delete group"
                  color="warn">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>

        <!-- Loading Spinner -->
        <div class="loading-container" *ngIf="loading">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading groups...</p>
        </div>

        <!-- No Data Message -->
        <div class="no-data-container"
          *ngIf="!loading && dataSource.filteredData?.length === 0">
          <mat-icon>group_off</mat-icon>
          <h3>No Groups Found</h3>
          <p>Create your first group to start organizing users.</p>
        </div>
      </div>

      <!-- Paginator -->
      <mat-paginator
        [pageSizeOptions]="[10, 25, 50]"
        [pageSize]="25"
        showFirstLastButtons
        *ngIf="(dataSource.filteredData?.length || 0) > 0">
      </mat-paginator>
    </mat-card-content>
  </mat-card>

  <!-- User Management Overlay -->
  <div class="user-management-overlay" *ngIf="showUserManagement"
    (click)="closeUserManagement()">
    <div class="user-management-dialog" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>
          <mat-icon>group_add</mat-icon>
          Manage Group Members
        </h2>
        <p class="dialog-subtitle">{{ selectedGroupForUsers?.name }}</p>
        <button mat-icon-button (click)="closeUserManagement()"
          class="close-button">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="dialog-content">
        <div class="search-section">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Search users</mat-label>
            <input matInput
              [(ngModel)]="userSearchText"
              placeholder="Search by name or email">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>
        </div>

        <div class="selection-summary">
          <mat-chip color="primary" class="selection-chip">
            <mat-icon>people</mat-icon>
            {{ selectedUserCount }} selected
          </mat-chip>
        </div>

        <div class="users-list">
          <div class="user-item"
            *ngFor="let user of filteredUsers; trackBy: trackByUserId"
            [class.selected]="user.selected"
            (click)="toggleUserSelection(user)">
            <mat-checkbox
              [(ngModel)]="user.selected"
              color="primary">
            </mat-checkbox>

            <div class="user-info">
              <div class="user-name">{{ user.name }}</div>
              <div class="user-email">{{ user.email }}</div>
            </div>
          </div>

          <div class="no-users" *ngIf="filteredUsers.length === 0">
            <mat-icon>person_search</mat-icon>
            <p>No users found matching your search.</p>
          </div>
        </div>
      </div>

      <div class="dialog-actions">
        <button mat-button (click)="closeUserManagement()">
          Cancel
        </button>
        <button mat-raised-button
          color="primary"
          (click)="saveGroupUsers()">
          <mat-icon>save</mat-icon>
          Save Changes
        </button>
      </div>
    </div>
  </div>
</div>